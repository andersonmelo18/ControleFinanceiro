<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Painel â€” Controle Financeiro AutÃ´nomo</title>

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIGURAÃ‡ÃƒO DE FALLBACK/OBRIGATÃ“RIA (Usando o config original do usuÃ¡rio)
      const FALLBACK_CONFIG = {
          apiKey: "AIzaSyBXCMMXEM-e_BNftJNcm6XeEGZ7KYPUiAY",
          authDomain: "controle-financeiro-b7880.firebaseapp.com",
          databaseURL: "https://controle-financeiro-b7880-default-rtdb.firebaseio.com",
          projectId: "controle-financeiro-b7880",
          storageBucket: "controle-financeiro-b7880.firebasestorage.app",
          messagingSenderId: "149823899793",
          appId: "1:149823899793:web:0fcdcd8ece6748697e9730"
      };
      
      // TENTA USAR A CONFIGURAÃ‡ÃƒO DO AMBIENTE, SENÃƒO USA O FALLBACK
      let firebaseConfig = FALLBACK_CONFIG;
      let initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      if (typeof __firebase_config !== 'undefined' && __firebase_config) {
          try {
              const envConfig = JSON.parse(__firebase_config);
              firebaseConfig = { ...FALLBACK_CONFIG, ...envConfig };
          } catch (e) {
              console.warn("Erro ao parsear __firebase_config. Usando FALLBACK_CONFIG.", e);
          }
      }

      // 1. Inicializar Firebase
      try {
          const app = initializeApp(firebaseConfig);
          
          // 2. Inicializar ServiÃ§os e expor globalmente
          window.db = getFirestore(app);
          window.auth = getAuth(app);
          setLogLevel('debug'); 

          // 3. AutenticaÃ§Ã£o
          async function authenticate() {
              let userCredential;
              if (initialAuthToken) {
                  userCredential = await signInWithCustomToken(window.auth, initialAuthToken);
              } else {
                  userCredential = await signInAnonymously(window.auth);
              }
              window.currentUserId = userCredential.user.uid; 
              
              const userIdDisplay = document.getElementById('user-id-display');
              if (userIdDisplay) userIdDisplay.textContent = window.currentUserId;
          }
          
          authenticate().catch(error => {
              console.error("Erro final na autenticaÃ§Ã£o do Firebase:", error);
              const userIdDisplay = document.getElementById('user-id-display');
              if (userIdDisplay) userIdDisplay.textContent = 'Erro de Auth';
              window.currentUserId = null;
          });

      } catch (error) {
          console.error("Erro ao inicializar o Firebase. Verifique a configuraÃ§Ã£o.", error);
          document.addEventListener('DOMContentLoaded', () => {
              const userIdDisplay = document.getElementById('user-id-display');
              if (userIdDisplay) userIdDisplay.textContent = 'Erro de InicializaÃ§Ã£o';
          });
      }
    </script>
    
    <script type="module" src="script.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-tabs">
            <a href="index.html"><button class="tab-button active">ğŸ  Painel</button></a>
            <a href="entradas.html"><button class="tab-button">â¡ï¸ Entradas</button></a>
            <a href="despesas.html"><button class="tab-button">â¬…ï¸ Despesas</button></a>
            <a href="fixos.html"><button class="tab-button">ğŸ“Œ Fixos/DÃ­vidas</button></a>
            <a href="cartoes.html"><button class="tab-button">ğŸ’³ CartÃµes</button></a>
        </div>

        <div class="header-section">
            <h1 style="margin-bottom:0;">Painel de Controle Mensal</h1>
            <p style="margin-top:0;">UsuÃ¡rio: <span style="font-size:10px; color:var(--cor-destaque); font-family:monospace; margin-left:4px;">UID: <span id="user-id-display">Carregando...</span></span></p>

            <div class="month-selector">
                <button onclick="changeMonth(-1)">&lt; MÃªs Anterior</button>
                <span id="current-month-display" class="month-label">Carregando...</span>
                <button onclick="changeMonth(1)">PrÃ³ximo MÃªs &gt;</button>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div id="total-entradas" class="card">
                <h4>Total Entradas (MÃªs)</h4>
                <p class="value">R$ 0,00</p>
            </div>
            <div id="total-despesas" class="card">
                <h4>Total Despesas (MÃªs)</h4>
                <p class="value">R$ 0,00</p>
            </div>
            <div id="lucro-liquido" class="card">
                <h4>Lucro LÃ­quido</h4>
                <p class="value">R$ 0,00</p>
            </div>
            <div id="saldo-caixa" class="card">
                <h4>Saldo em Caixa (Dinheiro/PIX)</h4>
                <p class="value">R$ 0,00</p>
            </div>

            <div class="card">
                <h4>ğŸ Totais Operacionais</h4>
                <div class="card-item"><span>Km Total Rodado</span><span id="total-km" style="font-weight:bold;">0.0 km</span></div>
                <div class="card-item"><span>Horas Trabalhadas</span><span id="total-hours" style="font-weight:bold;">0.0 h</span></div>
            </div>

            <div class="card">
                <h4>ğŸ’³ Total Faturas a Pagar</h4>
                <p id="total-faturas-display" class="value" style="color:var(--cor-erro);">R$ 0,00</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card" style="grid-column: span 2;">
                <h3>ğŸ“Œ Detalhamento de Despesas (Geral)</h3>
                <div class="card-item"><span>Despesas VariÃ¡veis</span><span id="var-exp-value" style="font-weight:bold;color:var(--cor-erro)">R$ 0,00</span></div>
                <div class="card-item"><span>Despesas Fixas e DÃ­vidas</span><span id="fix-exp-value" style="font-weight:bold;color:var(--cor-erro)">R$ 0,00</span></div>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                <button id="export-csv-btn" class="submit-btn">Exportar CSV (Excel)</button>
                <button id="export-pdf-btn" class="submit-btn">Exportar PDF</button>
            </div>

            <div style="display:flex; gap:12px; margin-top:12px; flex-direction:column;">
                <div class="card" style="min-height:260px;">
                    <h4>GrÃ¡fico â€” Receitas vs Despesas</h4>
                    <div style="height:200px;"><canvas id="chart-donut"></canvas></div>
                </div>

                <div class="card" style="min-height:260px;">
                    <h4>Gastos por Categoria</h4>
                    <div style="height:220px"><canvas id="chart-bar"></canvas></div>
                </div>

                <div class="card">
                    <h4>Resumo Mensal</h4>
                    <div id="monthly-summary-table"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>